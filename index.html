<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VisualExtractor NFe - Versão Completa PRO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="font-family:Arial;margin:0;padding:0">
<!-- SELETOR DE TEMA -->
<div id="seletorTema" style="position:fixed;top:20px;right:20px;z-index:1000;background:white;padding:10px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.2)">
<label style="font-weight:bold">🎨 Tema:</label>
<select onchange="alterarTema(this.value)" style="margin-left:10px;padding:5px;border-radius:5px">
<option value="azul">🔵 Azul Padrão</option>
<option value="verde">🟢 Verde Empresarial</option>
<option value="roxo">🟣 Roxo Moderno</option>
<option value="laranja">🟠 Laranja Vibrante</option>
<option value="escuro">⚫ Modo Escuro</option>
</select>
</div>
<div id="container" style="max-width:1200px;margin:0 auto;padding:20px;background:var(--bg-color, #e8f4fd);min-height:100vh">
<h1 id="titulo" style="background:var(--primary-color, linear-gradient(135deg,#3498db,#2980b9));color:white;padding:25px;text-align:center;border-radius:15px;margin-bottom:30px;font-size:2.2em">
🧾 VisualExtractor NFe - Versão PRO
</h1>
<!-- INFORMAÇÕES GERAIS DA NFE -->
<div id="infoCompleta" style="display:none;margin-bottom:30px;padding:25px;background:white;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1)">
<h3 style="color:#2c3e50;margin-bottom:25px;font-size:1.5em">📋 Informações Completas da NFe</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:25px">
<div style="background:#f8f9fa;padding:20px;border-radius:10px">
<h4 style="color:#27ae60;margin-bottom:15px">🏢 DADOS DO EMISSOR</h4>
<p><strong>Nome:</strong><br><span id="nomeEmissor" style="font-weight:bold"></span></p>
<p><strong>CNPJ:</strong><br><span id="cnpjEmissor" style="font-weight:bold;color:#e74c3c"></span></p>
<p><strong>Endereço:</strong><br><span id="enderecoEmissor"></span></p>
</div>
<div style="background:#f8f9fa;padding:20px;border-radius:10px">
<h4 style="color:#3498db;margin-bottom:15px">🏪 DADOS DO DESTINATÁRIO</h4>
<p><strong>Nome:</strong><br><span id="nomeDestinatario" style="font-weight:bold"></span></p>
<p><strong>CNPJ/CPF:</strong><br><span id="cnpjDestinatario" style="font-weight:bold;color:#e74c3c"></span></p>
<p><strong>Endereço:</strong><br><span id="enderecoDestinatario"></span></p>
</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:25px">
<div style="background:#fff3cd;padding:15px;border-radius:10px;text-align:center">
<p><strong>📅 Data de Emissão</strong><br><span id="dataEmissao" style="font-weight:bold;color:#856404"></span></p>
</div>
<div style="background:#d4edda;padding:15px;border-radius:10px;text-align:center">
<p><strong>🔢 Número da NFe</strong><br><span id="numeroNFe" style="font-weight:bold;color:#155724;font-size:1.2em"></span></p>
</div>
<div style="background:#cce5ff;padding:15px;border-radius:10px;text-align:center">
<p><strong>🔑 Série</strong><br><span id="serieNFe" style="font-weight:bold;color:#004085"></span></p>
</div>
</div>
<div style="background:#f1f3f4;padding:20px;border-radius:10px;margin-bottom:20px">
<h4 style="color:#6c757d;margin-bottom:10px">🔢 Chave de Acesso Completa</h4>
<p id="chaveAcesso" style="font-family:monospace;font-size:1.1em;font-weight:bold;color:#495057;word-break:break-all"></p>
</div>
<div style="background:#e7f3ff;padding:20px;border-radius:10px">
<h4 style="color:#0366d6;margin-bottom:10px">📋 Observações da NFe</h4>
<p id="observacoes" style="color:#586069;line-height:1.6"></p>
</div>
</div>
<!-- UPLOAD MÚLTIPLO -->
<div style="border:3px dashed var(--primary-color, #3498db);padding:40px;text-align:center;margin:30px 0;border-radius:15px;background:white">
<h3 style="color:#2c3e50;margin-bottom:20px">📁 Upload Múltiplo de XMLs da NFe</h3>
<input type="file" id="xmlFiles" accept=".xml" multiple style="margin-bottom:20px;padding:15px;border:2px solid var(--primary-color, #3498db);border-radius:10px;width:100%;max-width:500px">
<br>
<button onclick="processarMultiplosXML()" style="padding:15px 30px;background:var(--primary-color, linear-gradient(135deg,#27ae60,#229954));color:white;border:none;border-radius:10px;font-weight:bold;font-size:16px;cursor:pointer;margin:10px">🔄 PROCESSAR XMLs</button>
<button onclick="limparTudo()" style="padding:15px 30px;background:#e74c3c;color:white;border:none;border-radius:10px;font-weight:bold;font-size:16px;cursor:pointer;margin:10px">🗑️ LIMPAR TUDO</button>
</div>
<div id="status" style="padding:20px;margin:20px 0;border-radius:10px;font-weight:bold;background:#d1ecf1;color:#0c5460;text-align:center">🎯 Aguardando arquivos XML das Notas Fiscais…</div>
<!-- FILTROS -->
<div id="filtros" style="display:none;background:white;padding:25px;border-radius:15px;margin:20px 0;box-shadow:0 5px 15px rgba(0,0,0,0.1)">
<h3 style="color:#2c3e50;margin-bottom:20px">🔍 Filtros e Pesquisa</h3>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:15px;margin-bottom:20px">
<input type="text" id="filtroDescricao" placeholder="🔍 Buscar por descrição…" style="padding:12px;border:2px solid #ddd;border-radius:8px">
<input type="number" id="filtroValorMin" placeholder="💰 Valor mínimo" step="0.01" style="padding:12px;border:2px solid #ddd;border-radius:8px">
<input type="number" id="filtroValorMax" placeholder="💰 Valor máximo" step="0.01" style="padding:12px;border:2px solid #ddd;border-radius:8px">
<select id="filtroNFe" style="padding:12px;border:2px solid #ddd;border-radius:8px">
<option value="">📋 Todas as NFes</option>
</select>
</div>
<button onclick="aplicarFiltros()" style="padding:12px 25px;background:var(--primary-color, #3498db);color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer">🔍 APLICAR FILTROS</button>
<button onclick="limparFiltros()" style="padding:12px 25px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-left:10px">🗑️ LIMPAR</button>
</div>
<!-- RESUMO E ESTATÍSTICAS -->
<div id="resumoGeral" style="display:none;margin:30px 0">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px">
<div style="background:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.1);border-left:5px solid #3498db">
<h3 style="font-size:2.5em;color:#3498db;margin-bottom:10px" id="totalNFes">0</h3>
<p style="color:#7f8c8d;font-weight:bold;font-size:1.1em">📋 NFes Processadas</p>
</div>
<div style="background:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.1);border-left:5px solid #27ae60">
<h3 style="font-size:2.5em;color:#27ae60;margin-bottom:10px" id="totalProdutos">0</h3>
<p style="color:#7f8c8d;font-weight:bold;font-size:1.1em">📦 Total de Produtos</p>
</div>
<div style="background:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.1);border-left:5px solid #e74c3c">
<h3 style="font-size:2em;color:#e74c3c;margin-bottom:10px" id="valorTotalSemImpostos">R$ 0,00</h3>
<p style="color:#7f8c8d;font-weight:bold;font-size:1.1em">💰 Valor SEM Impostos</p>
</div>
<div style="background:var(--primary-color, #3498db);padding:25px;border-radius:15px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.2);color:white">
<h3 style="font-size:2em;margin-bottom:10px" id="valorTotalComImpostos">R$ 0,00</h3>
<p style="font-weight:bold;font-size:1.1em">💎 Valor COM Impostos</p>
</div>
<div style="background:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.1);border-left:5px solid #f39c12">
<h3 style="font-size:2em;color:#f39c12;margin-bottom:10px" id="totalImpostos">R$ 0,00</h3>
<p style="color:#7f8c8d;font-weight:bold;font-size:1.1em">🏛️ Total de Impostos</p>
</div>
</div>
<!-- GRÁFICOS -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px">
<div style="background:white;padding:25px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1)">
<h4 style="color:#2c3e50;margin-bottom:20px;text-align:center">📊 Valores por NFe</h4>
<canvas id="graficoNFes" width="400" height="200"></canvas>
</div>
<div style="background:white;padding:25px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1)">
<h4 style="color:#2c3e50;margin-bottom:20px;text-align:center">🏛️ Distribuição de Impostos</h4>
<canvas id="graficoImpostos" width="400" height="200"></canvas>
</div>
</div>
</div>
<!-- BOTÕES DE EXPORT -->
<div id="botoesExport" style="display:none;text-align:center;margin:30px 0;padding:25px;background:white;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.1)">
<h3 style="color:#2c3e50;margin-bottom:25px">📤 Exportar Dados</h3>
<button onclick="exportarCSV()" style="padding:15px 25px;background:#28a745;color:white;border:none;border-radius:10px;font-weight:bold;margin:10px;cursor:pointer">📄 CSV</button>
<button onclick="exportarExcel()" style="padding:15px 25px;background:#1f7a1f;color:white;border:none;border-radius:10px;font-weight:bold;margin:10px;cursor:pointer">📊 EXCEL</button>
<button onclick="exportarPDF()" style="padding:15px 25px;background:#dc3545;color:white;border:none;border-radius:10px;font-weight:bold;margin:10px;cursor:pointer">📋 PDF</button>
<button onclick="exportarJSON()" style="padding:15px 25px;background:#6f42c1;color:white;border:none;border-radius:10px;font-weight:bold;margin:10px;cursor:pointer">🗃️ JSON</button>
</div>
<!-- TABELA DE PRODUTOS -->
<div id="resultados" style="display:none">
<h3 style="color:#2c3e50;margin-bottom:20px;font-size:1.8em">📊 Produtos Extraídos (Filtrados: <span id="produtosFiltrados">0</span>)</h3>
<div style="overflow-x:auto;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1)">
<table id="tabelaProdutos" style="width:100%;border-collapse:collapse;background:white;font-size:0.9em">
<thead>
<tr style="background:var(--primary-color, linear-gradient(135deg,#34495e,#2c3e50));color:white">
<th style="padding:15px;text-align:left;position:sticky;top:0">NFe</th>
<th style="padding:15px;text-align:left;position:sticky;top:0">Código</th>
<th style="padding:15px;text-align:left;position:sticky;top:0">Descrição</th>
<th style="padding:15px;text-align:center;position:sticky;top:0">Qtd</th>
<th style="padding:15px;text-align:right;position:sticky;top:0">Unit. S/ Imp.</th>
<th style="padding:15px;text-align:right;position:sticky;top:0;background:var(--accent-color, #3498db)">Unit. C/ Imp. ⭐</th>
<th style="padding:15px;text-align:right;position:sticky;top:0">Total</th>
<th style="padding:15px;text-align:center;position:sticky;top:0">ICMS</th>
<th style="padding:15px;text-align:center;position:sticky;top:0">IPI</th>
<th style="padding:15px;text-align:center;position:sticky;top:0">PIS</th>
<th style="padding:15px;text-align:center;position:sticky;top:0">COFINS</th>
</tr>
</thead>
<tbody id="corpoTabela"></tbody>
</table>
</div>
</div>
</div>
<script>
// VARIÁVEIS GLOBAIS
var todasNFes = [];
var todosProdutos = [];
var produtosFiltrados = [];
var temaAtual = 'azul';
// TEMAS
var temas = {
    azul: {
        '--bg-color': '#e8f4fd',
        '--primary-color': 'linear-gradient(135deg,#3498db,#2980b9)',
        '--accent-color': '#3498db'
    },
    verde: {
        '--bg-color': '#e8f5e8',
        '--primary-color': 'linear-gradient(135deg,#27ae60,#219a52)',
        '--accent-color': '#27ae60'
    },
    roxo: {
        '--bg-color': '#f3e8ff',
        '--primary-color': 'linear-gradient(135deg,#8e44ad,#7d3c98)',
        '--accent-color': '#8e44ad'
    },
    laranja: {
        '--bg-color': '#fef5e7',
        '--primary-color': 'linear-gradient(135deg,#f39c12,#e67e22)',
        '--accent-color': '#f39c12'
    },
    escuro: {
        '--bg-color': '#2c3e50',
        '--primary-color': 'linear-gradient(135deg,#34495e,#2c3e50)',
        '--accent-color': '#3498db'
    }
};
function alterarTema(tema) {
    var root = document.documentElement;
    var temaSelecionado = temas[tema];
for (var propriedade in temaSelecionado) {
    root.style.setProperty(propriedade, temaSelecionado[propriedade]);
}

if (tema === 'escuro') {
    document.body.style.color = '#ecf0f1';
    var elementos = document.querySelectorAll('div, h1, h3, h4, p, span');
    for (var i = 0; i &lt; elementos.length; i++) {
        if (elementos[i].style.background === 'white' || elementos[i].style.backgroundColor === 'white') {
            elementos[i].style.background = '#34495e';
            elementos[i].style.color = '#ecf0f1';
        }
    }
} else {
    document.body.style.color = '';
    var elementos = document.querySelectorAll('div, h1, h3, h4, p, span');
    for (var i = 0; i &lt; elementos.length; i++) {
        if (elementos[i].style.background === '#34495e') {
            elementos[i].style.background = 'white';
            elementos[i].style.color = '';
        }
    }
}

temaAtual = tema;

}
function processarMultiplosXML() {
    var arquivos = document.getElementById('xmlFiles').files;
    if (arquivos.length === 0) {
        mostrarStatus('❌ Por favor, selecione pelo menos um arquivo XML', 'error');
        return;
    }
mostrarStatus('🔄 Processando ' + arquivos.length + ' arquivos XML...', 'info');

todasNFes = [];
todosProdutos = [];
var arquivosProcessados = 0;

for (var i = 0; i &lt; arquivos.length; i++) {
    processarArquivoXML(arquivos[i], function() {
        arquivosProcessados++;
        if (arquivosProcessados === arquivos.length) {
            finalizarProcessamento();
        }
    });
}

}
function processarArquivoXML(arquivo, callback) {
    var leitor = new FileReader();
    leitor.onload = function(evento) {
        try {
            var conteudoXML = evento.target.result;
        // LIMPAR ENTIDADES XML
        conteudoXML = conteudoXML.replace(/&gt;/g, '&gt;');
        conteudoXML = conteudoXML.replace(/&lt;/g, '&lt;');
        conteudoXML = conteudoXML.replace(/&amp;/g, '&');
        conteudoXML = conteudoXML.replace(/&quot;/g, '"');
        conteudoXML = conteudoXML.replace(/&apos;/g, "'");

        var parser = new DOMParser();
        var documentoXML = parser.parseFromString(conteudoXML, 'text/xml');

        var erroParser = documentoXML.querySelector('parsererror');
        if (erroParser) {
            throw new Error('XML inválido: ' + erroParser.textContent);
        }

        var dadosNFe = extrairDadosCompletos(documentoXML);
        var produtos = extrairProdutosCompletos(documentoXML, dadosNFe.numero);

        todasNFes.push(dadosNFe);
        todosProdutos = todosProdutos.concat(produtos);

        callback();

    } catch (erro) {
        console.error('Erro ao processar arquivo:', erro);
        callback();
    }
};

leitor.readAsText(arquivo, 'UTF-8');

}
function extrairDadosCompletos(documentoXML) {
    var dadosNFe = {
        emissor: 'N/A',
        cnpjEmissor: 'N/A',
        enderecoEmissor: 'N/A',
        destinatario: 'N/A',
        cnpjDestinatario: 'N/A',
        enderecoDestinatario: 'N/A',
        dataEmissao: 'N/A',
        numero: 'N/A',
        serie: 'N/A',
        chaveAcesso: 'N/A',
        observacoes: 'N/A'
    };
try {
    // DADOS DO EMISSOR
    var emit = documentoXML.querySelector('emit');
    if (emit) {
        dadosNFe.emissor = obterTexto(emit, 'xNome') || obterTexto(emit, 'xFant') || 'N/A';
        dadosNFe.cnpjEmissor = formatarCNPJ(obterTexto(emit, 'CNPJ')) || 'N/A';

        var enderEmit = emit.querySelector('enderEmit');
        if (enderEmit) {
            dadosNFe.enderecoEmissor = [
                obterTexto(enderEmit, 'xLgr'),
                obterTexto(enderEmit, 'nro'),
                obterTexto(enderEmit, 'xBairro'),
                obterTexto(enderEmit, 'xMun'),
                obterTexto(enderEmit, 'UF'),
                formatarCEP(obterTexto(enderEmit, 'CEP'))
            ].filter(function(item) { return item && item !== 'N/A'; }).join(', ');
        }
    }

    // DADOS DO DESTINATÁRIO
    var dest = documentoXML.querySelector('dest');
    if (dest) {
        dadosNFe.destinatario = obterTexto(dest, 'xNome') || 'N/A';
        dadosNFe.cnpjDestinatario = formatarCNPJ(obterTexto(dest, 'CNPJ')) || formatarCPF(obterTexto(dest, 'CPF')) || 'N/A';

        var enderDest = dest.querySelector('enderDest');
        if (enderDest) {
            dadosNFe.enderecoDestinatario = [
                obterTexto(enderDest, 'xLgr'),
                obterTexto(enderDest, 'nro'),
                obterTexto(enderDest, 'xBairro'),
                obterTexto(enderDest, 'xMun'),
                obterTexto(enderDest, 'UF'),
                formatarCEP(obterTexto(enderDest, 'CEP'))
            ].filter(function(item) { return item && item !== 'N/A'; }).join(', ');
        }
    }

    // DADOS GERAIS
    var ide = documentoXML.querySelector('ide');
    if (ide) {
        var dhEmi = obterTexto(ide, 'dhEmi') || obterTexto(ide, 'dEmi');
        if (dhEmi) {
            if (dhEmi.indexOf('T') !== -1) {
                var data = new Date(dhEmi);
                dadosNFe.dataEmissao = data.toLocaleDateString('pt-BR') + ' às ' + data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            } else {
                dadosNFe.dataEmissao = dhEmi;
            }
        }

        dadosNFe.numero = obterTexto(ide, 'nNF') || 'N/A';
        dadosNFe.serie = obterTexto(ide, 'serie') || 'N/A';
    }

    // CHAVE DE ACESSO
    var infNFe = documentoXML.querySelector('infNFe');
    if (infNFe && infNFe.getAttribute('Id')) {
        dadosNFe.chaveAcesso = infNFe.getAttribute('Id').replace('NFe', '');
    }

    // OBSERVAÇÕES
    var infAdic = documentoXML.querySelector('infAdic');
    if (infAdic) {
        dadosNFe.observacoes = obterTexto(infAdic, 'infCpl') || 'Nenhuma observação';
    }

} catch (erro) {
    console.error('Erro ao extrair dados da NFe:', erro);
}

return dadosNFe;

}
function extrairProdutosCompletos(documentoXML, numeroNFe) {
    var produtos = [];
try {
    var itens = documentoXML.querySelectorAll('det');

    for (var i = 0; i &lt; itens.length; i++) {
        var item = itens[i];
        var prod = item.querySelector('prod');

        if (prod) {
            var produto = {
                nfe: numeroNFe,
                codigo: obterTexto(prod, 'cProd') || 'N/A',
                descricao: obterTexto(prod, 'xProd') || 'N/A',
                quantidade: parseFloat(obterTexto(prod, 'qCom') || '0'),
                valorUnitarioSemImpostos: parseFloat(obterTexto(prod, 'vUnCom') || '0'),
                valorTotalBase: parseFloat(obterTexto(prod, 'vProd') || '0'),
                icms: 0,
                ipi: 0,
                pis: 0,
                cofins: 0
            };

            // EXTRAIR IMPOSTOS DETALHADOS
            var impostos = item.querySelector('imposto');
            if (impostos) {
                // ICMS
                var icmsElements = impostos.querySelectorAll('[tag*="ICMS"] vICMS, [tag*="icms"] vICMS, vICMS');
                for (var j = 0; j &lt; icmsElements.length; j++) {
                    produto.icms += parseFloat(icmsElements[j].textContent || '0');
                }

                // IPI
                var ipiElements = impostos.querySelectorAll('vIPI');
                for (var k = 0; k &lt; ipiElements.length; k++) {
                    produto.ipi += parseFloat(ipiElements[k].textContent || '0');
                }

                // PIS
                var pisElements = impostos.querySelectorAll('vPIS');
                for (var l = 0; l &lt; pisElements.length; l++) {
                    produto.pis += parseFloat(pisElements[l].textContent || '0');
                }

                // COFINS
                var cofinsElements = impostos.querySelectorAll('vCOFINS');
                for (var m = 0; m &lt; cofinsElements.length; m++) {
                    produto.cofins += parseFloat(cofinsElements[m].textContent || '0');
                }
            }

            produto.totalImpostos = produto.icms + produto.ipi + produto.pis + produto.cofins;
            produto.valorTotalComImpostos = produto.valorTotalBase + produto.totalImpostos;
            produto.valorUnitarioComImpostos = produto.quantidade &gt; 0 ? produto.valorTotalComImpostos / produto.quantidade : 0;

            produtos.push(produto);
        }
    }
} catch (erro) {
    console.error('Erro ao extrair produtos:', erro);
}

return produtos;

}
function finalizarProcessamento() {
    if (todasNFes.length === 0) {
        mostrarStatus('❌ Nenhuma NFe foi processada com sucesso', 'error');
        return;
    }
produtosFiltrados = todosProdutos.slice();

preencherInformacoesCompletas();
exibirResumoG
