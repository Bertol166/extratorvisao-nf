<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VisualExtractor NFe Premium - Completo</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
:root {
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --danger-color: #e74c3c;
    --warning-color: #f39c12;
    --dark-color: #2c3e50;
    --light-color: #ecf0f1;
    --success-color: #27ae60;
}

{
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}
.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    overflow: hidden;
}
.header {
    background: linear-gradient(135deg, var(--primary-color), #2980b9);
    color: white;
    padding: 30px;
    text-align: center;
    position: relative;
}
.header h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}
.header p {
    font-size: 1.2em;
    opacity: 0.9;
}
.theme-selector {
    position: absolute;
    top: 20px;
    right: 20px;
}
.theme-btn {
    background: rgba(255,255,255,0.2);
    border: 2px solid rgba(255,255,255,0.3);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    margin: 0 5px;
    font-size: 0.9em;
    transition: all 0.3s;
}
.theme-btn:hover, .theme-btn.active {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
}
.main-content {
    padding: 40px;
}
.upload-section {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    border: 3px dashed var(--primary-color);
    text-align: center;
    transition: all 0.3s;
}
.upload-section:hover {
    border-color: var(--secondary-color);
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.upload-area {
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
}
.upload-icon {
    font-size: 4em;
    color: var(--primary-color);
    margin-bottom: 20px;
}
.file-input {
    display: none;
}
.upload-btn {
    background: linear-gradient(135deg, var(--primary-color), #2980b9);
    color: white;
    padding: 15px 30px;
    border: none;
    border-radius: 50px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    margin: 10px;
}
.upload-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(52, 152, 219, 0.4);
}
.process-btn {
    background: linear-gradient(135deg, var(--secondary-color), #27ae60);
    color: white;
    padding: 15px 40px;
    border: none;
    border-radius: 50px;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    margin: 10px;
}
.process-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(46, 204, 113, 0.4);
}
.filters-section {
    display: none;
    background: #f8f9fa;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
    border-left: 5px solid var(--warning-color);
}
.filter-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}
.filter-item {
    display: flex;
    flex-direction: column;
}
.filter-item label {
    font-weight: bold;
    margin-bottom: 8px;
    color: var(--dark-color);
}
.filter-item input, .filter-item select {
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1em;
    transition: border-color 0.3s;
}
.filter-item input:focus, .filter-item select:focus {
    outline: none;
    border-color: var(--primary-color);
}
.stats-section {
    display: none;
    margin-bottom: 30px;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
.stat-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transition: transform 0.3s;
}
.stat-card:hover {
    transform: translateY(-5px);
}
.stat-card h3 {
    font-size: 2.5em;
    margin-bottom: 10px;
}
.stat-card p {
    font-size: 1.1em;
    opacity: 0.9;
}
.chart-container {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}
.results-section {
    display: none;
}
.export-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 25px;
    justify-content: center;
}
.export-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    color: white;
}
.export-csv { background: linear-gradient(135deg, #27ae60, #2ecc71); }
.export-excel { background: linear-gradient(135deg, #27ae60, #2ecc71); }
.export-pdf { background: linear-gradient(135deg, #e74c3c, #c0392b); }
.export-json { background: linear-gradient(135deg, #f39c12, #e67e22); }
.export-btn:hover {
    transform: translateY(-3px);
    filter: brightness(110%);
}
.table-container {
    overflow-x: auto;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.data-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    font-size: 0.9em;
}
.data-table th {
    background: linear-gradient(135deg, var(--dark-color), #34495e);
    color: white;
    padding: 15px 10px;
    text-align: left;
    font-weight: bold;
    border-bottom: 3px solid var(--primary-color);
}
.data-table td {
    padding: 12px 10px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.3s;
}
.data-table tr:hover {
    background-color: #f8f9fa;
}
.data-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.valor-destaque {
    font-weight: bold;
    color: var(--success-color);
    font-size: 1.1em;
}
.info-adicional {
    font-size: 0.8em;
    color: #666;
    margin-top: 5px;
}
.status {
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
    font-weight: bold;
    text-align: center;
    display: none;
}
.status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.status.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
.progress-bar {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin: 20px 0;
    display: none;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    width: 0%;
    transition: width 0.3s;
}
.loading {
    text-align: center;
    padding: 40px;
    display: none;
}
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.file-list {
    margin-top: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
}
.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin: 5px 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.file-info {
    flex-grow: 1;
}
.file-name {
    font-weight: bold;
    color: var(--dark-color);
}
.file-size {
    font-size: 0.8em;
    color: #666;
}
.remove-file {
    background: var(--danger-color);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8em;
}
@media (max-width: 768px) {
    .container {
        margin: 10px;
        border-radius: 15px;
    }
.main-content {
    padding: 20px;
}

.header h1 {
    font-size: 2em;
}

.data-table {
    font-size: 0.8em;
}

.data-table th,
.data-table td {
    padding: 8px 5px;
}

.stats-grid {
    grid-template-columns: 1fr;
}

.filter-group {
    grid-template-columns: 1fr;
}

.export-buttons {
    flex-direction: column;
}

.theme-selector {
    position: static;
    margin-top: 20px;
}

}
/* Temas */
.theme-dark {
    --primary-color: #6c5ce7;
    --secondary-color: #00b894;
    --dark-color: #2d3436;
}
.theme-green {
    --primary-color: #00b894;
    --secondary-color: #00cec9;
    --dark-color: #2d3436;
}
.theme-purple {
    --primary-color: #a29bfe;
    --secondary-color: #fd79a8;
    --dark-color: #636e72;
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="theme-selector">
            <button class="theme-btn active" onclick="setTheme('default')">Azul</button>
            <button class="theme-btn" onclick="setTheme('dark')">Escuro</button>
            <button class="theme-btn" onclick="setTheme('green')">Verde</button>
            <button class="theme-btn" onclick="setTheme('purple')">Roxo</button>
        </div>
        <h1>🧾 VisualExtractor NFe Premium</h1>
        <p>Sistema Completo de Extração e Análise de Notas Fiscais Eletrônicas</p>
    </div>
&lt;div class="main-content"&gt;
    &lt;!-- Seção de Upload --&gt;
    &lt;div class="upload-section"&gt;
        &lt;div class="upload-area" id="uploadArea"&gt;
            &lt;div class="upload-icon"&gt;📁&lt;/div&gt;
            &lt;h3&gt;Selecione ou Arraste os Arquivos XML&lt;/h3&gt;
            &lt;p&gt;Suporte para múltiplos arquivos simultâneos&lt;/p&gt;
            &lt;input type="file" id="fileInput" class="file-input" multiple accept=".xml" onchange="handleFiles(this.files)"&gt;
            &lt;button class="upload-btn" onclick="document.getElementById('fileInput').click()"&gt;
                📂 Selecionar Arquivos XML
            &lt;/button&gt;
            &lt;button class="process-btn" id="processBtn" onclick="processAllFiles()" style="display:none;"&gt;
                🚀 Processar Todos os Arquivos
            &lt;/button&gt;
        &lt;/div&gt;

        &lt;div class="file-list" id="fileList" style="display:none;"&gt;
            &lt;h4&gt;📋 Arquivos Selecionados:&lt;/h4&gt;
            &lt;div id="fileItems"&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Progresso --&gt;
    &lt;div class="progress-bar" id="progressBar"&gt;
        &lt;div class="progress-fill" id="progressFill"&gt;&lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Loading --&gt;
    &lt;div class="loading" id="loading"&gt;
        &lt;div class="spinner"&gt;&lt;/div&gt;
        &lt;p&gt;Processando arquivos XML...&lt;/p&gt;
    &lt;/div&gt;

    &lt;!-- Status --&gt;
    &lt;div class="status" id="status"&gt;&lt;/div&gt;

    &lt;!-- Filtros --&gt;
    &lt;div class="filters-section" id="filtersSection"&gt;
        &lt;h3&gt;🔍 Filtros e Busca&lt;/h3&gt;
        &lt;div class="filter-group"&gt;
            &lt;div class="filter-item"&gt;
                &lt;label&gt;🔍 Buscar Produto:&lt;/label&gt;
                &lt;input type="text" id="searchProduct" placeholder="Digite o nome do produto..."&gt;
            &lt;/div&gt;
            &lt;div class="filter-item"&gt;
                &lt;label&gt;💰 Valor Mínimo:&lt;/label&gt;
                &lt;input type="number" id="minValue" placeholder="0.00" step="0.01"&gt;
            &lt;/div&gt;
            &lt;div class="filter-item"&gt;
                &lt;label&gt;💰 Valor Máximo:&lt;/label&gt;
                &lt;input type="number" id="maxValue" placeholder="999999.99" step="0.01"&gt;
            &lt;/div&gt;
            &lt;div class="filter-item"&gt;
                &lt;label&gt;🏢 Emissor:&lt;/label&gt;
                &lt;select id="filterEmissor"&gt;
                    &lt;option value=""&gt;Todos os Emissores&lt;/option&gt;
                &lt;/select&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;button class="process-btn" onclick="applyFilters()"&gt;🔍 Aplicar Filtros&lt;/button&gt;
        &lt;button class="upload-btn" onclick="clearFilters()"&gt;🔄 Limpar Filtros&lt;/button&gt;
    &lt;/div&gt;

    &lt;!-- Estatísticas --&gt;
    &lt;div class="stats-section" id="statsSection"&gt;
        &lt;div class="stats-grid"&gt;
            &lt;div class="stat-card"&gt;
                &lt;h3 id="totalFiles"&gt;0&lt;/h3&gt;
                &lt;p&gt;📄 Arquivos Processados&lt;/p&gt;
            &lt;/div&gt;
            &lt;div class="stat-card"&gt;
                &lt;h3 id="totalProducts"&gt;0&lt;/h3&gt;
                &lt;p&gt;📦 Total de Produtos&lt;/p&gt;
            &lt;/div&gt;
            &lt;div class="stat-card"&gt;
                &lt;h3 id="totalValue"&gt;R$ 0,00&lt;/h3&gt;
                &lt;p&gt;💰 Valor Total&lt;/p&gt;
            &lt;/div&gt;
            &lt;div class="stat-card"&gt;
                &lt;h3 id="totalTax"&gt;R$ 0,00&lt;/h3&gt;
                &lt;p&gt;🏛️ Total de Impostos&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="chart-container"&gt;
            &lt;canvas id="valueChart"&gt;&lt;/canvas&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Resultados --&gt;
    &lt;div class="results-section" id="resultsSection"&gt;
        &lt;div class="export-buttons"&gt;
            &lt;button class="export-btn export-csv" onclick="exportCSV()"&gt;📊 Exportar CSV&lt;/button&gt;
            &lt;button class="export-btn export-excel" onclick="exportExcel()"&gt;📈 Exportar Excel&lt;/button&gt;
            &lt;button class="export-btn export-pdf" onclick="exportPDF()"&gt;📋 Exportar PDF&lt;/button&gt;
            &lt;button class="export-btn export-json" onclick="exportJSON()"&gt;🗃️ Exportar JSON&lt;/button&gt;
        &lt;/div&gt;

        &lt;div class="table-container"&gt;
            &lt;table class="data-table" id="dataTable"&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;📄 NFe&lt;/th&gt;
                        &lt;th&gt;🏢 Emissor&lt;/th&gt;
                        &lt;th&gt;🏪 Destinatário&lt;/th&gt;
                        &lt;th&gt;📦 Produto&lt;/th&gt;
                        &lt;th&gt;🔢 Código&lt;/th&gt;
                        &lt;th&gt;📏 Unidade&lt;/th&gt;
                        &lt;th&gt;🔢 Quantidade&lt;/th&gt;
                        &lt;th&gt;💰 Valor Unit.&lt;/th&gt;
                        &lt;th&gt;💰 Valor Total&lt;/th&gt;
                        &lt;th&gt;🏛️ ICMS&lt;/th&gt;
                        &lt;th&gt;🏛️ IPI&lt;/th&gt;
                        &lt;th&gt;🏛️ PIS&lt;/th&gt;
                        &lt;th&gt;🏛️ COFINS&lt;/th&gt;
                        &lt;th&gt;💰 Total c/ Impostos&lt;/th&gt;
                        &lt;th&gt;📅 Data Emissão&lt;/th&gt;
                        &lt;th&gt;🔑 Chave NFe&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody id="tableBody"&gt;
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

</div>
<script>
// Variáveis globais
var allData = [];
var filteredData = [];
var selectedFiles = [];
// Configurar drag and drop
document.addEventListener('DOMContentLoaded', function() {
    var uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#2ecc71';
    uploadArea.style.backgroundColor = '#f0f9ff';
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#3498db';
    uploadArea.style.backgroundColor = '';
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#3498db';
    uploadArea.style.backgroundColor = '';
    handleFiles(e.dataTransfer.files);
});

// Configurar filtros em tempo real
document.getElementById('searchProduct').addEventListener('input', applyFilters);
document.getElementById('minValue').addEventListener('input', applyFilters);
document.getElementById('maxValue').addEventListener('input', applyFilters);
document.getElementById('filterEmissor').addEventListener('change', applyFilters);

});
function handleFiles(files) {
    selectedFiles = Array.from(files);
    displayFileList();
    document.getElementById('processBtn').style.display = 'inline-block';
}
function displayFileList() {
    var fileList = document.getElementById('fileList');
    var fileItems = document.getElementById('fileItems');
if (selectedFiles.length === 0) {
    fileList.style.display = 'none';
    return;
}

fileList.style.display = 'block';
fileItems.innerHTML = '';

selectedFiles.forEach(function(file, index) {
    var fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = 
        '&lt;div class="file-info"&gt;' +
            '&lt;div class="file-name"&gt;📄 ' + file.name + '&lt;/div&gt;' +
            '&lt;div class="file-size"&gt;' + formatFileSize(file.size) + '&lt;/div&gt;' +
        '&lt;/div&gt;' +
        '&lt;button class="remove-file" onclick="removeFile(' + index + ')"&gt;❌&lt;/button&gt;';
    fileItems.appendChild(fileItem);
});

}
function removeFile(index) {
    selectedFiles.splice(index, 1);
    displayFileList();
    if (selectedFiles.length === 0) {
        document.getElementById('processBtn').style.display = 'none';
    }
}
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    var k = 1024;
    var sizes = ['Bytes', 'KB', 'MB', 'GB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
function processAllFiles() {
    if (selectedFiles.length === 0) {
        mostrarStatus('⚠️ Selecione pelo menos um arquivo XML!', 'error');
        return;
    }
allData = [];
var processedCount = 0;

// Mostrar loading e progress
document.getElementById('loading').style.display = 'block';
document.getElementById('progressBar').style.display = 'block';

selectedFiles.forEach(function(file, index) {
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var parser = new DOMParser();
            var xmlDoc = parser.parseFromString(e.target.result, 'text/xml');
            var dados = extrairDadosCompletos(xmlDoc, file.name);

            if (dados && dados.length &gt; 0) {
                allData = allData.concat(dados);
            }

            processedCount++;
            updateProgress(processedCount, selectedFiles.length);

            if (processedCount === selectedFiles.length) {
                finishProcessing();
            }
        } catch (error) {
            console.error('Erro ao processar', file.name, ':', error);
            processedCount++;
            updateProgress(processedCount, selectedFiles.length);

            if (processedCount === selectedFiles.length) {
                finishProcessing();
            }
        }
    };
    reader.readAsText(file);
});

}
function updateProgress(current, total) {
    var percent = (current / total) * 100;
    document.getElementById('progressFill').style.width = percent + '%';
}
function finishProcessing() {
    // Esconder loading
    document.getElementById('loading').style.display = 'none';
    document.getElementById('progressBar').style.display = 'none';
if (allData.length === 0) {
    mostrarStatus('❌ Nenhum dado foi extraído dos arquivos XML!', 'error');
    return;
}

filteredData = allData.slice();

// Mostrar seções
document.getElementById('filtersSection').style.display = 'block';
document.getElementById('statsSection').style.display = 'block';
document.getElementById('resultsSection').style.display = 'block';

// Atualizar interface
updateTable();
updateStats();
updateChart();
populateEmissorFilter();

mostrarStatus('✅ ' + allData.length + ' produtos extraídos de ' + selectedFiles.length + ' arquivo(s) com sucesso!', 'success');

}
function extrairDadosCompletos(xmlDoc, nomeArquivo) {
    var produtos = [];
try {
    // Buscar namespace correto
    var nfeRoot = xmlDoc.getElementsByTagName('nfeProc')[0] || 
                 xmlDoc.getElementsByTagName('NFe')[0] ||
                 xmlDoc.getElementsByTagName('infNFe')[0];

    if (!nfeRoot) {
        console.error('Estrutura NFe não encontrada em:', nomeArquivo);
        return produtos;
    }

    // Dados da NFe
    var infNFe = nfeRoot.getElementsByTagName('infNFe')[0] || nfeRoot;
    var ide = infNFe.getElementsByTagName('ide')[0];
    var emit = infNFe.getElementsByTagName('emit')[0];
    var dest = infNFe.getElementsByTagName('dest')[0];
    var det = infNFe.getElementsByTagName('det');

    // Informações gerais
    var numeroNFe = ide ? getElementText(ide, 'nNF') : 'N/A';
    var chaveNFe = infNFe.getAttribute('Id') || 'N/A';
    var dataEmissao = ide ? getElementText(ide, 'dhEmi').split('T')[0] : 'N/A';

    // Dados do emissor
    var nomeEmissor = emit ? getElementText(emit, 'xNome') : 'N/A';
    var cnpjEmissor = emit ? getElementText(emit, 'CNPJ') : 'N/A';
    var endEmissor = emit ? getEnderecoCompleto(emit.getElementsByTagName('enderEmit')[0]) : 'N/A';

    // Dados do destinatário
    var nomeDestinatario = dest ? getElementText(dest, 'xNome') : 'N/A';
    var cnpjDestinatario = dest ? getElementText(dest, 'CNPJ') : 'N/A';
    var endDestinatario = dest ? getEnderecoCompleto(dest.getElementsByTagName('enderDest')[0]) : 'N/A';

    // Observações
    var observacoes = getElementText(infNFe, 'infCpl') || 'N/A';

    // Processar produtos
    for (var i = 0; i &lt; det.length; i++) {
        var produto = det[i].getElementsByTagName('prod')[0];
        var imposto = det[i].getElementsByTagName('imposto')[0];

        if (!produto) continue;

        // Dados básicos do produto
        var nomeProduto = getElementText(produto, 'xProd');
        var codigoProduto = getElementText(produto, 'cProd');
        var unidade = getElementText(produto, 'uCom');
        var quantidade = parseFloat(getElementText(produto, 'qCom')) || 0;
        var valorUnitario = parseFloat(getElementText(produto, 'vUnCom')) || 0;
        var valorTotal = parseFloat(getElementText(produto, 'vProd')) || 0;

        // Impostos detalhados
        var impostos = extrairImpostos(imposto);
        var totalImpostos = impostos.icms + impostos.ipi + impostos.pis + impostos.cofins;
        var valorComImpostos = valorTotal + totalImpostos;

        produtos.push({
            arquivo: nomeArquivo,
            numeroNFe: numeroNFe,
            chaveNFe: chaveNFe,
            dataEmissao: dataEmissao,
            nomeEmissor: nomeEmissor,
            cnpjEmissor: cnpjEmissor,
            enderecoEmissor: endEmissor,
            nomeDestinatario: nomeDestinatario,
            cnpjDestinatario: cnpjDestinatario,
            enderecoDestinatario: endDestinatario,
            observacoes: observacoes,
            nomeProduto: nomeProduto,
            codigoProduto: codigoProduto,
            unidade: unidade,
            quantidade: quantidade,
            valorUnitario: valorUnitario,
            valorTotal: valorTotal,
            icms: impostos.icms,
            ipi: impostos.ipi,
            pis: impostos.pis,
            cofins: impostos.cofins,
            totalImpostos: totalImpostos,
            valorComIm
